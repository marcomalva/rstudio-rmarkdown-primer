---
title: Literate Programming with R Markdown
subtitle: Show Convergence of Sample Variance Estimators with Simulation
author:
  - Yuki Yanai (original document)
  - Marco Malva (minor modifications)
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
  github_document:
    toc: true
---

```{r global_option, include=FALSE}
## Options for the whole markdown document.
## This chunk doesn't appear in the output because "include=FALSE"
knitr::opts_chunk$set(warning = FALSE, echo = TRUE, message = TRUE,
                      fig.width = 6, fig.height = 5)
if (file.exists("~/.Rprofile")) source("~/.Rprofile")  ## apply .Rprofile when knitr the markdown
```

<br>

# Introduction

## How Use This Document

You should open this Rmd file with RStudio but any text editor will do.

In order to generate and view it as a HTML file click on the Knit icon ![img](figs/knit-icon.png) in RStudio.

If you are not familiar with RStudio you might want to quickly read [R Markdown Quick Tour](https://rmarkdown.rstudio.com/authoring_quick_tour.html)

The current, work-in-progress version of this R Markdown file is available [Literate-Programming.Rmd | Github develop](https://github.com/marcomalva/rstudio-rmarkdown-primer/blob/develop/topic/distribution-shape/Literate-Programming.Rmd).

## Goal

The goal of this document is to give

1. A brief overview of Markdown
1. A brief overview of R Markdown and literate programming
1. Discuss the biased and non biased estimator for sample variance
1. Show the bias on a single sample
1. Show the convergence of biased and non biased estimator with increased sample size using R simulation

## Audience

The document is best suited to those who

- already have some basic statistical knowledge and
- have used RStudio at least once or twice already

For those who do not know about RStudio or R it can serve as an illustration as what is
possible and how easy it is to get started.

## What is R Markdown

R Markdown is Markdown combined with R using the `knitr` package. 
It was originally generated by [Yihui Xhi](https://yihui.org/), at that time a PhD student at the Iowa State University.
There is the [presentation](https://slides.yihui.org/2020-covid-rmarkdown.html#1) about it.

R Markdown is a variation of **literate programming** where the author combines normal text with
programming instructions such that when run through a program the output combines the normal text
with the programming instructions. 

This allows to share and reproduce data research in an easy to read way while adding the processing capabilities
of the computer programs. It also allows to run the combine the same text with different data sets for repetitive 
tasks or evolving data set. 

As it does not use a special file format you can open and edit the file with any text editor.
However, it is best if you use a dedicated editor such as RStudio.

The text files can also be nicely version controlled by a version control system such as `git`.
This way one can capture ow the text and the compute instructions change over time.

One can find a **few hundreds "published" books written in R Markdown** on [Bookdown | Home](https://bookdown.org/).
Many of which are published but available for free online, for example:

* [R Markdown: The Definitive Guide | Yihui Xie, J. J. Allaire, Garrett Grolemund](https://bookdown.org/yihui/rmarkdown/)
* [R Markdown Cookbook | Yihui Xie, Christophe Dervieux, Emily Riederer](https://bookdown.org/yihui/rmarkdown-cookbook/)
* [R Graphics Cookbook, 2nd edition | Winston Chang](https://r-graphics.org/)

About a **million R Markdown reports** are published to [RPubs](https://rpubs.com/).
You can publish your own documents with one click to the publish icon ![publish icon](figs/publish-icon-fs8.png).
All you need is a free account with RPubs.

A couple of these published reports:

* [RPubs - How to publish paper(s) online?](https://rpubs.com/cathydatascience/518692)
* [RPubs - Solving Integrals - DATA 605 HW13](https://rpubs.com/melbow2424/1035808)

One downside is that there source file, that is the R Markdown, is not published alongside the HTML document on RPubs.
This means, that the author must either be so kind to provide a link to the R Markdown file hosted in some other place,
like for example Github, or one must a little trick to embed the R Markdown file as a download link inside the
published HTML file: [RPubs - Including Rmd Source in RPubs](https://rpubs.com/ramnathv/including_rmd_source).

If you are interested in publishing articles from R Markdown have a look at: [Distill for R Markdown: Publishing Articles](https://rstudio.github.io/distill/publish_article.html).

There is a web site for R in Journalism: [Getting started :: Journalism with R](https://learn.r-journalism.com/en/introduction/).

## Alternatives

Another, popular open source alternative to R Markdown is [Jupyter Notebook | Project Jupyter Home](https://jupyter.org/).

## Credits

This is a slightly modified R Markdown document originally written by Yuki Yanai.

- The original R Markdown [Yuki Yanai's R Markdown](http://yukiyanai.github.io/teaching/rm1/contents/R/Literate-Programming.Rmd).
- The original HTML file [Literate Programming | Yuki Yanai](http://yukiyanai.github.io/teaching/rm1/contents/R/Literate-Programming.html)

The modifications were focused on making the document more useful to a reader who is new to RStudio and R Markdown. The R code blocks were not
modified other than what was necessary to avoid `knit` errors. All other changes are about providing more context and additional resources to the reader,
remove unnecessary details, and give a brief introduction into drawing a normal distributed sample.

1. Make `source("~/.Rprofile")` conditional on existence of the file `~/.Rprofile` as otherwise it won't knit if you do not have that file
1. Remove the comments on Yuki Yanai's CSS file as it is not needed to get started
1. Remove the comments about generating the HTML file as clicking Knit in RStudio is more adequate for a beginner
1. Add more context about the goals of this document
1. Add more context on the benefits and goals of Markdown and R Markdown
1. Add sections and subsections to get a useful TOC
1. Use the YAML header to specify the output and at a TOC
1. Add links to useful resources for picking the right graph type for your data or to find inspiration
1. Add links to useful resources for creating a large variety of chart types
1. Add information about published reports and books
1. Add section about drawing normal distributed values
1. Add plot of drawn sample with vertical lines for mean +/- standard deviation
1. Add section about adding charts as/from code blocks
1  Add section that lists which libraries were used, a good practice for reproducible documents
1. Add note on help function
1. Add links to published books

## Changelog

Changes applied after and in addition to the changes from the original documents listed in the section [Credits](#Credits):

1. Add Change log section
1. Add `github_document` to `output` as target in YAML so we get a markdown file that renders nicely on Github
1. Add Output Targets section and sub section on `github_document` output.

# Markdown Basics

In Markdown and R Markdown  you can simply write your sentences as usual.

## Italic and Bold Fonts

You can make some words italic like *this is italic* or _this is also italic_.
You can also use the bold font like **this** or __this__.
The bold italic can be used like ***this*** or ___this___.

To begin a new line, insert a line between sentences.

## Bullet Points

You can create bullet points as follows.

 * Item 1
 * Item 2
    * Item 2-1
    * Item 2-2

Alternatively,

- Item 1
    - Item 1-1
    - Item 1-2
- Item 2

A single space is necessary after * or -. To make nested lists, indent blocks by tab.

## Numberd Lists

Numbered lists can be created as follows.

1. First item
1. Second item
    1. What?
    1. How?
1. Third item

Note that the numbers you enter only indicate that the list is numbered.  The ordered numbers are automatically assigned in the output, so you don't have to worry about the numbering. It might be a good practice to use only "1" for numbered lists in order to make re-ordering easy.

## Local and Remote Links

You can paste a link like this: [Yuki Yanai's Website](http://yukiyanai.com/).

You can insert a local image in the page: ![R Logo Local](figs/Rlogo-fs8.png)

You can also show remote images with their URL: ![R Logo Remote](http://www.r-project.org/Rlogo.png)

> I used `pngquant` to compress the PNG image down to `11 KB` from `32 KB`.

## Mathematical Formulae

You can write math formula as you do in LaTeX.
To write an inline formula, type LaTeX style formula between `$`s. 
E.g., $\bar{x} = \sum_{i=1}^n x_i / n.$
To write formula in an independent block, type LaTeX style formula between `$$`s.
E.g.,
$$\sigma^2 = \frac{\sum_{i=1}^n (x_i - \mu)^2}{n}.$$

# R Markdown Basics

R Markdown is Markdown plus the ability to have R code chunks that can be evaluated by R and do statistical computation.
R Markdown also supports the execution of other languages such as `python` or `bash`.
The focus of this document is however on R code blocks which is also the most common use case for R Markdown.

Markdown typically only renders code chunks with language specific syntax highlighting which makes code blocks much nicer to read.
Some markdown processor allow to add line numbering, line highlighting and other features on top of the syntax highlighting.
There also various plugin/extension to markdown that treat specific code blocks more like instructions, which is typically used
to generate charts such as flow-charts, sequence diagram, gant diagrams and others from a textual specification of the chat.

## R Code Chunks

In R Markdown files, you write R codes in blocks called *code chunks*.
A simple code chunk is like this:
```{r example-chunk}
a <- 1:10
b <- -1:-10
```

As this example shows, the code chunk starts and ends with three back quotes (\`\`\`) (Note that the end mark must be three back quotes too, not three quotes).
After the first three back quotes, write {r} to tell the program that it is a chunk for R codes.After "r" and a space, you should write the name of a chunk.
You have to give a unique name to each chunk.

In RStudio you can also insert code chunks through the menu `Code | Insert Chunk` or the hot key combination `Alt - Ctrl -I`.

## Quoting R Variable Values in Text

To insert an R code (without the output) in a sentence, write, for instance, "you can obtain the mean of x by `mean(x)`".

To show the outcome (evaluated value) in a sentence, insert "r" before the command: "the mean of $a$ is `r mean(a)`".
The variable `a` is a vector with numbers from 1 to 10, i.e. `r a`.

> This is a key point of **literate programming** as it allows to insert computed values in to the text while also having the compute instructions within
> the same document so it is a single, cohesive source.

## Add Plot Charts

You can include figures and tables in R Markdown files.
```{r example-plot}
plot(a, b, main = "Scatter plot of b vs. a")
```

Many more plots are presented in the 1[R-Graph Gallery](https://r-graph-gallery.com/index.html).
It displays about 400 charts, alongside reproducible code and explanations.
The charts are organized by family and types.

If you are looking for an inspiration check out the [Dataviz Inspiration Site](https://www.dataviz-inspiration.com/).
It showcases 159 of the most beautiful and impactful dataviz projects.

If you are looking for a guide to pick the best graph type your data give [Data-To-Viz](https://www.data-to-viz.com/) a try.
It leads you to the most appropriate graph for your data. It links to the code to build it and lists common caveats you should avoid.
The "Acknowledgements in the [Data-To-Viz | About Section](https://www.data-to-viz.com/about.html) are listed many good resources
to improve your R Markdown skills. These cover "story telling side" as well as technical aspects.

## Add Charts

There are additional plugin available to add the ability to generate a variety of charts from code blocks.
This is a larger subject and deferred to another document for a more in depth discussion.

For now just a few web links to get you started if you want to dive into it:

* [Diagrams in Rmarkdown Documents | DiagrammeR Package](https://rstudio-pubs-static.s3.amazonaws.com/194240_c9bc85a7f24b41a2b1f42724c525a109.html#1)
* [RStudio v0.99 Preview: Graphviz and DiagrammeR - Posit](https://posit.co/blog/rstudio-v0-99-preview-graphviz-and-diagrammer/)
* [Graphviz and mermaid in DiagrammeR • DiagrammeR](https://rich-iannone.github.io/DiagrammeR/articles/graphviz-mermaid.html)
* [Graph/Network Visualization • DiagrammeR](https://rich-iannone.github.io/DiagrammeR/)
* [DiagrammeR/mermaid flowchart in a Rmarkdown file](https://stackoverflow.com/questions/40803017/how-to-include-diagrammer-mermaid-flowchart-in-a-rmarkdown-file)
* [Gantt diagrams | Mermaid](https://mermaid.js.org/syntax/gantt.html)
* [Kroki!](https://kroki.io/)
* [nice-move/remark-kroki: Kroki plugin of remark](https://github.com/nice-move/remark-kroki)
* [Use of \`plantuml\` with knitr • plantuml](https://rkrug.github.io/plantuml/articles/use_with_knitr.html)

These cover some of them most well known programs to generate charts from text:

* Graphviz
* Mermaid
* Kroki
* PlantUml

## Deferring Output

By default, R evaluates the chunk at the first line(s), print the outcome of the line(s), and then moves to the next line.
E.g.,
```{r sd-and-var}
sd(a)
var(a)
```
As you can see, the result of `sd(a)` is printed before `var(a)` is evaluated.

To show results of the chunk together, set a chunk option **results** to 'hold'.
Chunk options are specified after the chunk names and a comma.
```{r example-option, results='hold'}
sd(a)
var(a)
```

## Draw Normal Distributed Sample

You can for example a sample of normal distributed values of size 300 with mean 0 and variance of 10 with:

```{r demo-rnorm}
xv1 <- rnorm(n=300, mean = 0, sd = sqrt(10)) # draw n=300 normal distributed values and store them in variable xv1
```

The _sample size_ is ``r length(xv1)``, the _mean_ is ``r mean(xv1)``, and its _standard deviation_ is ``r sd(xv1)``.

Showing the drawn sample in a histogram plot with vertical lines for the mean +/- standard deviation:

```{r visualize-norm-dist-with-mean-sd}
hist(xv1, breaks=60)
abline(v=mean(xv1)          , col="red")
abline(v=mean(xv1) - sd(xv1), col="blue")
abline(v=mean(xv1) + sd(xv1), col="blue")
```

## Supported Languages

It is worth noting that R Markdown is **not limited to R code blocks**.
About 40 languages are supported, one can list them with `names(knitr::knit_engines$get())`:

```{r get-languages}
names(knitr::knit_engines$get())
```

## Output Targets

The output targets are defined in the YAML section at the top of the document.

### github_document

The `.Rmd` file on Github is not nice to look at, i.e. take a glance at it [Literate-Programming.Rmd](https://github.com/marcomalva/rstudio-rmarkdown-primer/blob/develop/topic/distribution-shape/Literate-Programming.Rmd).

The `github_document` output generates a markdown document that renders nicely on Github. See also:

* [Creating and Pushing a R-Markdown Document to Github (including graphs)](https://gist.github.com/JoshuaTPierce/b919168421b40e06481080eb53c3fb2f)
* [github\_document: Convert to GitHub Flavored Markdown in rmarkdown: Dynamic Documents for R](https://rdrr.io/cran/rmarkdown/man/github_document.html)

The preview looks good. One has to add the generated files to git to be able to push them to Github.
I accomplished this from command line:

```{bash git_add, eval=FALSE, engine="sh"}
git add topic/distribution-shape/Literate-Programming.Rmd topic/distribution-shape/Literate-Programming.md topic/distribution-shape/Literate-Programming_files/
git commit
git push
```

## Getting Help

If any of the commands is unknown you can enter `?command` e.g. `?rnorm` to see the help page for that function. 

For more information about R Markdown, visit [R Markdown | RStudio](http://rmarkdown.rstudio.com/).

# Example: Simulations in R

## Variances and Unbiased Variances

Suppose the population variance of a random variable $X$ is $\sigma^2$.
Let $s^2$ denote the sample variance of $X$:
$$s^2 = \frac{\sum_{i=1}^n (x_i - \bar{x})^2}{n}.$$
Then, the expected value of the sample variance is
$$\mathrm{E}(s^2) = \frac{n-1}{n} \sigma^2.$$
This shows that $s^2$ is *not* the unbiased estimator of $\sigma^2$.
The unbiased estimator of $\sigma^2$ is $u^2$:
$$u^2 = \frac{n}{n-1}s^2 = \frac{\sum_{i=1}^n (x_i - \bar{x})^2}{n-1}.$$
It is easy to prove that $\mathrm{E}(u^2) = \sigma^2$, but let's verify it by simulations.

## Setting Up the Simulations

First, load the packages we will use.
```{r packages}
library("ggplot2")
library("dplyr")
```

Then, let's specify the sample size ($n$), the number of trials in a simulation, and the value of the  population variance ($\sigma^2$).
In addition, let's make a variable to save the simulation results.

```{r setup}
n <- 10         ## sample size
trials <- 1000  ## number of samples
sigma2 <- 10    ## True Variance
# prepare vectors to save the results
s2 <- rep(NA, trials)  ## vector to save sample variance
u2 <- rep(NA, trials)  ## vector to save unbiased variance
```

Now we are ready. Let's run a simulation.
Here, we use **for loop**.
```{r run-simulation1}
for (i in 1:trials) { ## loop for the simulation, i = 1, 2, ..., trials
    x <- rnorm(n, mean = 0, sd = sqrt(sigma2))  ## random sample from N(0, sigma^2)
    s2[i] <- sum((x - mean(x))^2) / n           ## sample variance
    u2[i] <- sum((x - mean(x))^2) / (n - 1)　   ## unbiased variance
}
rm(x)  ## remove x since we won't use it
```

Once the simulation is done, let's examine the results.
```{r show-sim1}
## variance
mean(s2)  ## mean of the sample variance
sd(s2)    ## sd of the sample variance
mean(u2)  ## mean of the unbiased variance
sd(u2)    ## sd of the unbiased variance
```
As this example shows, $s^2$ (s2) tends to be smaller than the true (population) variance.
<br>

## Write Functions to Run Simulations

Above, we wrote R codes to run a simulation. However, using the codes above, we have to run several codes again and again to repeat simulations.
To make it easy to iterate simulations, let's write a function to run simulations.

```{r sim-funtion1}
sim_var <- function(n, trials, true_var) {## function to simulate unbiased variance
    ## Arguments:
    ##    n = sample size
    ##    trials = num of iterations in a simulation
    ##    true_var = sigma^2 (population variance)
    ## Return: matrix of the means and sd's of s2 and u2
    s2 <- rep(NA, trials)
    u2 <- rep(NA, trials)
    for (i in 1:trials) { ## loop for a simulation
        x <- rnorm(n, sd = sqrt(true_var))  ## random sample from N(0, true.var)
        s2[i] <- sum((x - mean(x))^2) / n   ## sample variance
        u2[i] <- sum((x - mean(x))^2) / (n - 1) ## unbiased variance
    }
    res <- matrix(c(mean(s2), mean(u2), sd(s2), sd(u2)), nrow = 2)
    row.names(res) <- c("sample var.", "unbiased var.")
    colnames(res) <- c("mean", "sd")
    return(res)
}
```

Let's run a simulation with this function.
First, when $n=5$, run:
```{r simvar-n5}
sim_var(n = 5, trials = 1000, true_var = 10)
```
We got the result.

Let's increase the sample size to 10,
```{r simvar-n10}
sim_var(n = 10, trials = 1000, true_var = 10)
```

Using the function we created above, let's make a new function to run a simulation for different sample sizes simultaneously.
Here, we define a function to simulate all $n$'s between **n_min** and **n_max**.
```{r sim-function2}
sim_var2 <- function(n_min = 1, n_max, trials = 1000, true_var){
    ## Arguments:
    ##       n.min = the minimum, default to 1
    ##       n.max = the maximum, no default
    ##       trials = n. of iterations in a simulation, default to 1000
    ##       true_var = sigma^2 (the population variance)
    ## Return: A list of matrix returned by sim_var
    
    ## Print error message if the input value is wrong
    if (n_min < 1) stop(message = "n.min must be a positive integer")
    if (n_max < 1) stop(message = "n.max must be a positive integer")
    if (trials < 1) stop(message = "trials must be a positive integer")
    if (true_var < 0) stop(message = "true_var must be a positive value")
    
    ## sample sizes
    n_vec <- n_min:n_max
    ## matrix to save the result
    output <- matrix(NA, nrow = length(n_vec), ncol = 5)
    colnames(output) <- c("n", "s2_mean", "u2_mean", "s2_sd", "u2_sd")
    ## run simulation by for loop
    for (i in seq_along(n_vec)) {
        ## use the function we made before
        ## save the i-th result in the i-th row
        output[i, 1] <- n_vec[i]
        output[i, 2:5] <- as.vector(sim_var(n = n_vec[i], trials = trials, 
                                            true_var = true_var))
    }
    return(output)
}      
```


For instance, run a simulation for $n = 10, 11, \dots, 100$, and visualize the results.
```{r sim-var-n1to100, results='hold'}
sim1 <- sim_var2(n_min = 10, n_max = 100, trials = 1000, true_var = 10)
```

Lastly, let's visualize the result.

```{r visualize-simulation}
## make a data frame from the matrix
df <- data.frame(n = rep(sim1[, 1], 2),
                 mean = c(sim1[, 2], sim1[, 3]),
                 sd = c(sim1[, 4], sim1[, 5]),
                 type = c(rep("biased", dim(sim1)[1]), rep("unbiased", dim(sim1)[1])))
df <- df %>%
    mutate(lb = mean - sd, ub = mean + sd)
## make a plot
res_sim1 <- ggplot(df, aes(x = n, y = mean, color = type))
res_sim1 + 
    geom_line() +
    geom_abline(intercept = 10, slope = 0, color = "royalblue", linetype = "dashed") +
    scale_color_discrete(name = "variance", labels = c(expression(s^2), expression(u^2)))
```

The next figure displays the same result with error bars (mean $\pm$ sd).
```{r visualize-simulation-errors}
last_plot() + 
    geom_pointrange(aes(ymin = lb, ymax = ub))
```

# Appendix

## Session Info

It is a good practice to add a session info at the end of your document. It will increase reproducibility and costs only one line of code, see [Pimp my RMD: a few tips for R Markdown](https:
//holtzy.github.io/Pimp-my-rmd/).

```{r}
sessionInfo()
```
